<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <script src="http://d3js.org/d3.v3.min.js"></script> 
        <!-- <script src="d3.min.js"></script> -->
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <body>
        <button onclick="switchColors()">change colors!</button>
        <div class="description">
        </div>
        <script>

//var width = 1200;
//var height = 800;

var width = 900;
var height = 550;
var margin = {top: 20, right: 20, bottom: 30, left: 120};

var firstYear = 1901;
var lastYear = 2016;

var projection = d3.geo.mercator()
                   .translate([width / 2, height / 2])
                   .precision(.1)
                   .scale((width + 1) / 2 / Math.PI);

var path = d3.geo.path().projection(projection);

var svg = d3.select("body").append("svg")
            .attr({"width" : width + margin.left + margin.right, "height" : height + margin.top + margin.bottom})
            .append("g").attr("translate", "transform(" + margin.leff + ", " + margin.top + ")");

var tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

var cellSize = 27;

var colorCalibration_1 = ['#8B8B8B', '#ffffcc','#ffeda0','#fed976','#feb24c','#fd8d3c','#fc4e2a','#e31a1c','#bd0026','#800026'];
var colors_1 = ['#ffffcc','#ffeda0','#fed976','#feb24c','#fd8d3c','#fc4e2a','#e31a1c','#bd0026','#800026'];

var colorCalibration_2 = ['#8B8B8B', '#f7f4f9','#e7e1ef','#d4b9da','#c994c7','#df65b0','#e7298a','#ce1256','#980043','#67001f'];
var colors_2 = ['#f7f4f9','#e7e1ef','#d4b9da','#c994c7','#df65b0','#e7298a','#ce1256','#980043','#67001f'];

var colors = colors_1;
var colorCalibration = colorCalibration_1;

var widthDescription = 100;
var heightDescription = colorCalibration.length * (cellSize + 2);

var colorScale = d3.scale.threshold()
                   .domain([5, 10, 15, 20, 25, 50, 75, 100])
                   .range(colors);

var navHeight = 50;

var navChart = d3.select("body").append("svg")
                  .attr({"width" : width + margin.left + margin.right, "height" : navHeight + margin.top + margin.bottom})
                  .attr("class", "navigator")
                  .append("g").attr("transform", "translate(" + margin.left + ", " + margin.top + ")");
 
var parseToDate = d3.time.format("%Y").parse;

var navXScale = d3.time.scale().domain([parseToDate(firstYear + ""), parseToDate(lastYear + "")])
                  .range([0, width])
                  //.ticks(d3.time.year, 20)
                  .nice();

var navXAxis = d3.svg.axis()
                 .scale(navXScale)
                 .ticks(30)
                 .orient("bottom");

navChart.append("g")
         .attr("class", "x axis")
         .attr("transform", "translate(0, " + navHeight + ")")
         .call(navXAxis);

var group;

d3.json("world_map.json", function(world){

group = svg.selectAll("g")
              .data(world.features)
              .enter()
              .append("g");

group.append("path")
     .attr("d", path)
     .attr("class", "country")
     .attr("fill", "#8B8B8B");

group.on("mouseover", mouseover);

read_data();

});

initializeDescription();

function switchColors(){
    if(colors == colors_1){
        colors = colors_2;
        colorCalibration = colorCalibration_2;
    }
    else{
        colors = colors_1;
        colorCalibration = colorCalibration_1;
    }
    var legend = d3.select(".description").select("svg")
        .selectAll(".legend").data(colorCalibration);
      
    legend.select("rect").attr("fill", function(d) {return d;});
    
    colorScale.range(colors);

    update_map();

}

function mouseover(d){
    tooltip.text(d.properties.name)
           .style("opacity", .9)
           .style("left", d3.event.pageX + "px")
           .style("top", d3.event.pageY + "px");
}

function initializeDescription(){
    var desc = d3.select(".description").append("svg")
                 .attr("width", widthDescription)
                 .attr("height", heightDescription);
    var legend = desc.selectAll(".legend").data(colorCalibration)
                     .enter().append("g")
                     .attr("class", "legend")
                     .attr("width", widthDescription)
                     .attr("height", cellSize)
                     .attr("transform", function(d, i) { return "translate(0, " + (i * (cellSize + 2)) + ")"; });
    
    legend.append("rect")
          .attr("width", cellSize)
          .attr("height", cellSize)
          .attr("fill", function(d) { return d; });

    legend.append("text")
          .attr("y", cellSize / 2 + 5)
          .attr("x", cellSize + 4)
          .attr("font", "sans-serif")
          .text(function(d, i){
                if(i == 0){ return "No data"; }
                else if(i == colorScale.domain().length + 1) return " > " + colorScale.domain()[i - 2];
                return " < " + colorScale.domain()[i - 1];
          });
}

var winners;
var data;

//read_data();

function read_data(){
    d3.csv("winners.csv", beautify, function(winners_data){
        winners = winners_data;
        update_data();
        update_map();
    });    
}

function update_data(maxYear = 2016, minYear = 1901){
    var country_data = {};
    winners.forEach(function(d){
         if(d.year <= maxYear && d.year >= minYear){
             if(country_data[d.country] == undefined) country_data[d.country] = 1;
             else country_data[d.country]++;
        }
    });   
    data = Object.keys(country_data).map(function(key){
       return {"country" : key, "cnt" : country_data[key]};
    });
    console.log(data);
}

function update_map(){
    group.select("path").attr("fill", function(d){
       var cnt = find_country_cnt(d.properties.name, data);
       if(cnt == 0) return colorCalibration[0];
       else return colorScale(cnt);
    });
}

function find_country_cnt(name, data){
    var res = 0;
    data.forEach(function(d){    
        if(name == d.country){
            res = d.cnt;
        }
    });
    return +res;
}

function beautify(d){
    d.year = +d.year;
    d.name = d.name.trim();
    d.field = d.field.trim();
    d.country = d.country.trim();
    return d;
}

        </script>
    </body>
</html>
